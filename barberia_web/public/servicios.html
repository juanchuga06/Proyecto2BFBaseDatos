<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Servicios | Barbería T13</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>

    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <img src="/img/logo_black.jpg" class="nav-logo-icon" alt="Logo" style="border-radius: 50%;">
            MEN'S
        </a>
        <ul class="nav-links">
            <li><a href="/">INICIO</a></li>
            <li><a href="/busqueda.html">BÚSQUEDA</a></li>
            <li><a href="/reservar.html">RESERVAR CITA</a></li>
            <li><a href="/clientes.html">CLIENTES</a></li>
            <li><a href="/citas.html">CITAS</a></li>
            <li class="admin-only"><a href="/barberos.html">BARBEROS</a></li>
            <li class="admin-only"><a href="/servicios.html" class="active">SERVICIOS</a></li>
            <li class="admin-only"><a href="/sedes.html">SEDES</a></li>
            <li><a href="#" id="btnLogout">SALIR</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-title">
            <h1>Gestión de Servicios</h1>
            <p>Administra el catálogo de servicios y precios</p>
        </div>

        <div id="alertContainer"></div>

        <div class="grid grid-2">
            <!-- FORMULARIO -->
            <div class="card">
                <div class="card-header">Nuevo Servicio</div>
                <form id="formServicio">
                    <input type="hidden" id="servicioID" value="">

                    <div class="form-group">
                        <label for="nombreServicio">Nombre del Servicio</label>
                        <input type="text" id="nombreServicio" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="precio">Precio ($)</label>
                        <input type="number" id="precio" class="form-control" required step="0.01" min="0">
                    </div>

                    <div class="form-group">
                        <label for="duracion">Duración (minutos)</label>
                        <input type="number" id="duracion" class="form-control" required min="5" step="5" value="30">
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Guardar Servicio
                    </button>
                    <button type="button" id="btnCancelar" class="btn btn-outline"
                        style="width: 100%; margin-top: 0.5rem; display: none;">
                        Cancelar Edición
                    </button>
                </form>
            </div>

            <!-- LISTA -->
            <div class="card">
                <div class="card-header">Servicios Disponibles</div>
                <div id="listaServicios" style="max-height: 500px; overflow-y: auto;">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2026 Men's Barber. Todos los derechos reservados.</p>
    </footer>

    <script src="/js/app.js"></script>
    <script>
        // Verificar sesion y rol
        const session = JSON.parse(localStorage.getItem('barberia_session') || 'null');
        if (!session) {
            window.location.href = '/login.html';
        } else if (session.rol !== 'franquiciado') {
            alert('No tienes permisos para acceder a esta pagina');
            window.location.href = '/';
        }

        async function cargarServicios() {
            const servicios = await fetchAPI('/api/servicios');
            document.getElementById('listaServicios').innerHTML = servicios.map(s => `
                <div style="padding: 1rem; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${s.NombreServicio}</strong>
                        <span class="badge badge-gold">$${s.Precio}</span>
                        <br><small style="color: #888;">${s.DuracionMinutos || 30} minutos</small>
                    </div>
                    <div>
                        <button onclick="editarServicio(${s.ServicioID})" class="btn btn-outline" style="padding: 5px 10px; font-size: 0.8rem;">Editar</button>
                        <button onclick="eliminarServicio(${s.ServicioID})" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;">Eliminar</button>
                    </div>
                </div>
            `).join('') || '<p style="color: #888; padding: 1rem;">No hay servicios registrados</p>';
        }

        document.addEventListener('DOMContentLoaded', cargarServicios);

        document.getElementById('formServicio').addEventListener('submit', async (e) => {
            e.preventDefault();
            const servicioID = document.getElementById('servicioID').value;
            const isEdit = servicioID !== '';

            const data = {
                NombreServicio: document.getElementById('nombreServicio').value,
                Precio: parseFloat(document.getElementById('precio').value),
                DuracionMinutos: parseInt(document.getElementById('duracion').value)
            };

            try {
                const url = isEdit ? `/api/servicios/${servicioID}` : '/api/servicios';
                const method = isEdit ? 'PUT' : 'POST';

                const result = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(r => r.json());

                if (result.success) {
                    showAlert(isEdit ? 'Servicio actualizado' : 'Servicio registrado', 'success');
                    document.getElementById('formServicio').reset();
                    document.getElementById('servicioID').value = '';
                    document.getElementById('btnCancelar').style.display = 'none';
                    cargarServicios();
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        });

        async function editarServicio(id) {
            const servicios = await fetchAPI('/api/servicios');
            const s = servicios.find(x => x.ServicioID === id);
            if (s) {
                document.getElementById('servicioID').value = s.ServicioID;
                document.getElementById('nombreServicio').value = s.NombreServicio;
                document.getElementById('precio').value = s.Precio;
                document.getElementById('duracion').value = s.DuracionMinutos || 30;
                document.getElementById('btnCancelar').style.display = 'block';
            }
        }

        async function eliminarServicio(id) {
            if (!confirm('Seguro que deseas eliminar este servicio?')) return;
            try {
                const result = await fetch(`/api/servicios/${id}`, { method: 'DELETE' }).then(r => r.json());
                if (result.success) {
                    showAlert('Servicio eliminado', 'success');
                    cargarServicios();
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (err) {
                showAlert(err.message, 'danger');
            }
        }

        document.getElementById('btnCancelar').addEventListener('click', () => {
            document.getElementById('formServicio').reset();
            document.getElementById('servicioID').value = '';
            document.getElementById('btnCancelar').style.display = 'none';
        });

        document.getElementById('btnLogout').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('barberia_session');
            window.location.href = '/login.html';
        });
    </script>
</body>

</html>