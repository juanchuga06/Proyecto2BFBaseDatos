<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Barberos | Barbería T13</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>

    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <img src="/img/logo_black.jpg" class="nav-logo-icon" alt="Logo" style="border-radius: 50%;">
            MEN'S
        </a>
        <ul class="nav-links">
            <li><a href="/">INICIO</a></li>
            <li><a href="/busqueda.html">BÚSQUEDA</a></li>
            <li><a href="/reservar.html">RESERVAR CITA</a></li>
            <li><a href="/clientes.html">CLIENTES</a></li>
            <li><a href="/citas.html">CITAS</a></li>
            <li class="admin-only"><a href="/barberos.html" class="active">BARBEROS</a></li>
            <li class="admin-only"><a href="/servicios.html">SERVICIOS</a></li>
            <li class="admin-only"><a href="/sedes.html">SEDES</a></li>
            <li><a href="#" id="btnLogout">SALIR</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-title">
            <h1>Gestión de Barberos</h1>
            <p>Administra el personal de las sedes</p>
        </div>

        <div id="alertContainer"></div>

        <div class="grid grid-2">
            <!-- FORMULARIO -->
            <div class="card">
                <div class="card-header">Nuevo Barbero</div>
                <form id="formBarbero">
                    <input type="hidden" id="barberoID" value="">

                    <div class="form-group">
                        <label for="cedula">Cédula (10 dígitos)</label>
                        <input type="text" id="cedula" class="form-control" required pattern="[0-9]{10}" maxlength="10">
                    </div>

                    <div class="grid grid-2">
                        <div class="form-group">
                            <label for="nombres">Nombres</label>
                            <input type="text" id="nombres" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="apellidos">Apellidos</label>
                            <input type="text" id="apellidos" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="telefono">Teléfono</label>
                        <input type="text" id="telefono" class="form-control" required pattern="0[0-9]{9}"
                            maxlength="10">
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="fechaNacimiento">Fecha de Nacimiento</label>
                        <input type="date" id="fechaNacimiento" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="especialidad">Especialidad</label>
                        <select id="especialidad" class="form-control" required>
                            <option value="">Seleccione...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="sede">Sede</label>
                        <select id="sede" class="form-control" required>
                            <option value="">Seleccione...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="password">Contraseña de acceso</label>
                        <input type="password" id="password" class="form-control" placeholder="Para login del barbero">
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Guardar Barbero
                    </button>
                    <button type="button" id="btnCancelar" class="btn btn-outline"
                        style="width: 100%; margin-top: 0.5rem; display: none;">
                        Cancelar Edición
                    </button>
                </form>
            </div>

            <!-- LISTA -->
            <div class="card">
                <div class="card-header">Barberos Registrados</div>
                <div id="listaBarberos" style="max-height: 815px; overflow-y: auto;">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2026 Men's Barber. Todos los derechos reservados.</p>
    </footer>

    <script src="/js/app.js"></script>
    <script>
        // Verificar sesion y rol
        const session = JSON.parse(localStorage.getItem('barberia_session') || 'null');
        if (!session) {
            window.location.href = '/login.html';
        } else if (session.rol !== 'franquiciado') {
            alert('No tienes permisos para acceder a esta pagina');
            window.location.href = '/';
        }

        async function cargarDatos() {
            // Cargar especialidades
            const especialidades = await fetchAPI('/api/especialidades');
            document.getElementById('especialidad').innerHTML = '<option value="">Seleccione...</option>' +
                especialidades.map(e => `<option value="${e.EspecialidadID}">${e.NombreEspecialidad}</option>`).join('');

            // Cargar sedes
            const sedes = await fetchAPI('/api/sedes');
            document.getElementById('sede').innerHTML = '<option value="">Seleccione...</option>' +
                sedes.map(s => `<option value="${s.SedeID}">${s.NombreSede}</option>`).join('');

            // Cargar barberos
            await cargarBarberos();
        }

        async function cargarBarberos() {
            const barberos = await fetchAPI('/api/barberos');
            document.getElementById('listaBarberos').innerHTML = barberos.map(b => `
                <div style="padding: 1rem; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${b.Nombres} ${b.Apellidos}</strong>
                        <br><small style="color: #888;">${b.NombreEspecialidad || 'Sin especialidad'} - ${b.NombreSede || 'Sin sede'}</small>
                        <br><small style="color: #888;">${b.Email || 'Sin email'}</small>
                    </div>
                    <div>
                        <button onclick="editarBarbero(${b.BarberoID})" class="btn btn-outline" style="padding: 5px 10px; font-size: 0.8rem;">Editar</button>
                        <button onclick="eliminarBarbero(${b.BarberoID})" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;">Eliminar</button>
                    </div>
                </div>
            `).join('') || '<p style="color: #888; padding: 1rem;">No hay barberos registrados</p>';
        }

        document.addEventListener('DOMContentLoaded', cargarDatos);

        document.getElementById('formBarbero').addEventListener('submit', async (e) => {
            e.preventDefault();
            const barberoID = document.getElementById('barberoID').value;
            const isEdit = barberoID !== '';

            const data = {
                Cedula: document.getElementById('cedula').value,
                Nombres: document.getElementById('nombres').value,
                Apellidos: document.getElementById('apellidos').value,
                Telefono: document.getElementById('telefono').value,
                Email: document.getElementById('email').value || null,
                FechaNacimiento: document.getElementById('fechaNacimiento').value || null,
                EspecialidadID: parseInt(document.getElementById('especialidad').value),
                SedeID: parseInt(document.getElementById('sede').value),
                PasswordHash: document.getElementById('password').value || null
            };

            try {
                const url = isEdit ? `/api/barberos/${barberoID}` : '/api/barberos';
                const method = isEdit ? 'PUT' : 'POST';

                const result = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(r => r.json());

                if (result.success) {
                    showAlert(isEdit ? 'Barbero actualizado' : 'Barbero registrado', 'success');
                    document.getElementById('formBarbero').reset();
                    document.getElementById('barberoID').value = '';
                    document.getElementById('btnCancelar').style.display = 'none';
                    cargarBarberos();
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        });

        async function editarBarbero(id) {
            const barberos = await fetchAPI('/api/barberos');
            const b = barberos.find(x => x.BarberoID === id);
            if (b) {
                document.getElementById('barberoID').value = b.BarberoID;
                document.getElementById('cedula').value = b.Cedula;
                document.getElementById('nombres').value = b.Nombres;
                document.getElementById('apellidos').value = b.Apellidos;
                document.getElementById('telefono').value = b.Telefono;
                document.getElementById('email').value = b.Email || '';
                document.getElementById('fechaNacimiento').value = b.FechaNacimiento ? b.FechaNacimiento.split('T')[0] : '';
                document.getElementById('especialidad').value = b.EspecialidadID;
                document.getElementById('sede').value = b.SedeID;
                document.getElementById('btnCancelar').style.display = 'block';
            }
        }

        async function eliminarBarbero(id) {
            if (!confirm('Seguro que deseas eliminar este barbero?')) return;
            try {
                const result = await fetch(`/api/barberos/${id}`, { method: 'DELETE' }).then(r => r.json());
                if (result.success) {
                    showAlert('Barbero eliminado', 'success');
                    cargarBarberos();
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (err) {
                showAlert(err.message, 'danger');
            }
        }

        document.getElementById('btnCancelar').addEventListener('click', () => {
            document.getElementById('formBarbero').reset();
            document.getElementById('barberoID').value = '';
            document.getElementById('btnCancelar').style.display = 'none';
        });

        document.getElementById('btnLogout').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('barberia_session');
            window.location.href = '/login.html';
        });
    </script>
</body>

</html>