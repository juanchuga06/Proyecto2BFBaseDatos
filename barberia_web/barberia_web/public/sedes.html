<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Sedes | Barbería T13</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>

    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <img src="/img/logo_black.jpg" class="nav-logo-icon" alt="Logo" style="border-radius: 50%;">
            MEN'S
        </a>
        <ul class="nav-links">
            <li><a href="/">INICIO</a></li>
            <li><a href="/busqueda.html">BÚSQUEDA</a></li>
            <li><a href="/reservar.html">RESERVAR CITA</a></li>
            <li><a href="/clientes.html">CLIENTES</a></li>
            <li><a href="/citas.html">CITAS</a></li>
            <li class="admin-only"><a href="/barberos.html">BARBEROS</a></li>
            <li class="admin-only"><a href="/servicios.html">SERVICIOS</a></li>
            <li class="admin-only"><a href="/sedes.html" class="active">SEDES</a></li>
            <li><a href="#" id="btnLogout">SALIR</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-title">
            <h1>Gestión de Sedes</h1>
            <p>Administra las sucursales de la franquicia</p>
        </div>

        <div id="alertContainer"></div>

        <div class="grid grid-2">
            <!-- FORMULARIO -->
            <div class="card">
                <div class="card-header">Nueva Sede</div>
                <form id="formSede">
                    <input type="hidden" id="sedeID" value="">

                    <div class="form-group">
                        <label for="nombreSede">Nombre de la Sede</label>
                        <input type="text" id="nombreSede" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="direccion">Dirección</label>
                        <input type="text" id="direccion" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="ciudad">Ciudad</label>
                        <select id="ciudad" class="form-control" required>
                            <option value="">Seleccione...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="franquiciado">Franquiciado</label>
                        <select id="franquiciado" class="form-control" required>
                            <option value="">Seleccione...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="telefono">Teléfono</label>
                        <input type="text" id="telefono" class="form-control" pattern="0[0-9]{9}" maxlength="10">
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Guardar Sede
                    </button>
                    <button type="button" id="btnCancelar" class="btn btn-outline"
                        style="width: 100%; margin-top: 0.5rem; display: none;">
                        Cancelar Edición
                    </button>
                </form>
            </div>

            <!-- LISTA -->
            <div class="card">
                <div class="card-header">Sedes Registradas</div>
                <div id="listaSedes" style="max-height: 500px; overflow-y: auto;">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2026 Men's Barber. Todos los derechos reservados.</p>
    </footer>

    <script src="/js/app.js"></script>
    <script>
        // Verificar sesion y rol
        const session = JSON.parse(localStorage.getItem('barberia_session') || 'null');
        if (!session) {
            window.location.href = '/login.html';
        } else if (session.rol !== 'franquiciado') {
            alert('No tienes permisos para acceder a esta pagina');
            window.location.href = '/';
        }

        async function cargarDatos() {
            // Cargar ciudades
            const ciudades = await fetchAPI('/api/ciudades');
            document.getElementById('ciudad').innerHTML = '<option value="">Seleccione...</option>' +
                ciudades.map(c => `<option value="${c.CiudadID}">${c.NombreCiudad}</option>`).join('');

            // Cargar franquiciados
            const franquiciados = await fetchAPI('/api/franquiciados');
            document.getElementById('franquiciado').innerHTML = '<option value="">Seleccione...</option>' +
                franquiciados.map(f => `<option value="${f.FranquiciadoID}">${f.NombreCompleto}</option>`).join('');

            // Cargar sedes
            await cargarSedes();
        }

        async function cargarSedes() {
            const sedes = await fetchAPI('/api/sedes');
            document.getElementById('listaSedes').innerHTML = sedes.map(s => `
                <div style="padding: 1rem; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${s.NombreSede}</strong>
                        <br><small style="color: #888;">${s.Direccion || 'Sin direccion'}</small>
                        <br><small style="color: #888;">${s.NombreCiudad || 'Sin ciudad'} - ${s.Franquiciado || 'Sin franquiciado'}</small>
                    </div>
                    <div>
                        <button onclick="editarSede(${s.SedeID})" class="btn btn-outline" style="padding: 5px 10px; font-size: 0.8rem;">Editar</button>
                        <button onclick="eliminarSede(${s.SedeID})" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;">Eliminar</button>
                    </div>
                </div>
            `).join('') || '<p style="color: #888; padding: 1rem;">No hay sedes registradas</p>';
        }

        document.addEventListener('DOMContentLoaded', cargarDatos);

        document.getElementById('formSede').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sedeID = document.getElementById('sedeID').value;
            const isEdit = sedeID !== '';

            const data = {
                NombreSede: document.getElementById('nombreSede').value,
                Direccion: document.getElementById('direccion').value,
                CiudadID: parseInt(document.getElementById('ciudad').value),
                FranquiciadoID: parseInt(document.getElementById('franquiciado').value),
                Telefono: document.getElementById('telefono').value || null
            };

            try {
                const url = isEdit ? `/api/sedes/${sedeID}` : '/api/sedes';
                const method = isEdit ? 'PUT' : 'POST';

                const result = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(r => r.json());

                if (result.success) {
                    showAlert(isEdit ? 'Sede actualizada' : 'Sede registrada', 'success');
                    document.getElementById('formSede').reset();
                    document.getElementById('sedeID').value = '';
                    document.getElementById('btnCancelar').style.display = 'none';
                    cargarSedes();
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        });

        async function editarSede(id) {
            const sedes = await fetchAPI('/api/sedes');
            const s = sedes.find(x => x.SedeID === id);
            if (s) {
                document.getElementById('sedeID').value = s.SedeID;
                document.getElementById('nombreSede').value = s.NombreSede;
                document.getElementById('direccion').value = s.Direccion || '';
                document.getElementById('ciudad').value = s.CiudadID;
                document.getElementById('franquiciado').value = s.FranquiciadoID;
                document.getElementById('telefono').value = s.Telefono || '';
                document.getElementById('btnCancelar').style.display = 'block';
            }
        }

        async function eliminarSede(id) {
            if (!confirm('Seguro que deseas eliminar esta sede?')) return;
            try {
                const result = await fetch(`/api/sedes/${id}`, { method: 'DELETE' }).then(r => r.json());
                if (result.success) {
                    showAlert('Sede eliminada', 'success');
                    cargarSedes();
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (err) {
                showAlert(err.message, 'danger');
            }
        }

        document.getElementById('btnCancelar').addEventListener('click', () => {
            document.getElementById('formSede').reset();
            document.getElementById('sedeID').value = '';
            document.getElementById('btnCancelar').style.display = 'none';
        });

        document.getElementById('btnLogout').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('barberia_session');
            window.location.href = '/login.html';
        });
    </script>
</body>

</html>